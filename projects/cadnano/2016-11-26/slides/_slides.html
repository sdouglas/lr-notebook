<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title></title>
    <link rel="stylesheet" href="../../../../static/fonts/fa/css/font-awesome.min.css?h=512c7d79">
    <link rel="stylesheet" href="/static/lib/reveal/css/reveal.css">
    <link rel="stylesheet" href="/static/lib/reveal/css/theme/white.css" id="theme">
    <link rel="stylesheet" href="/static/slides.css">
    <style>#lektor-edit-link {display:none;}</style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
      
      <section data-markdown data-separator="^\n\n">
        ## PyQt3D

&lt;div class=&#34;right&#34;&gt;https://www.riverbankcomputing.com/software/pyqt3d/download&lt;/div&gt;

A development version of PyQt3D was released on November 1st, 2016.

&lt;div class=&#34;right&#34;&gt;Nick&#39;s install_pyqt_from_src.py: [817bd0f](https://github.com/cadnano/cadnano2.5/blob/817bd0f5046790255b4e812ab1230823d5376c5a/misc/pyqttools/install_pyqt_from_src.py)
&lt;/div&gt;

In order to get this running, we need to build the latest versions of PyQt and SIP, as well as the PyQt3D package. Fortunately, Nick already did 99% of the work in building a script to do this. His latest version had some vestiges of a &#34;--dev&#34; flag that didn&#39;t quite work, so I adapted it to download the dev versions of PyQt and SIP. My updated version is provided here for reference. It is fragile and won&#39;t work as soon as the dev snapshot extensions have changed.

&lt;div class=&#34;right&#34;&gt;My updated [install_pyqt_from_src.py](./install_pyqt_from_src.py)&lt;/div&gt;

For the Qt and PyQt builds, I re-enabled some of the QML and Qt Quick stuff that Nick had disabled. It seems that several Qt3D examples use QML to quickly declare UI settings, so I thought it might be useful to have them ready to go in the near future.

Before we can even install PyQt3D, we need the python3 environment set up correctly. First, I had to uninstall all my local copies of Python3, per StackOverflow [instructions](http://stackoverflow.com/questions/3819449/how-to-uninstall-python-2-7-on-a-mac-os-x-10-6-4/3819829#3819829). Next I used homebrew to install (and/or update) and link python3.

&lt;div class=&#34;right&#34;&gt;```
sudo rm -rf /Library/Frameworks/Python.framework/Versions/3.5
sudo rm -rf &#34;/Applications/Python 3.5&#34;
cd /usr/local/bin/
ls -l /usr/local/bin | \
   grep &#39;../Library/Frameworks/Python.framework/Versions/3.5&#39; | \
   awk &#39;{print $9}&#39; | tr -d @ | xargs rm
```
&lt;/div&gt;

Finally, I was able to create a new virtualenv, and run the install_pyqt_from_src.py script from within that environment. Once the latest version of PyQt is built within the virtualenv, I just cd to the PyQt3D directory, run `python3 configure.py` and then `make` and `make install`. If all goes according to plan, we should be able to successfully call `import PyQt5.Qt3DCore` from within python3.


After installing PyQt3D successfully, I was able to run the included example scripts in the `examples` folder. Here are some screenshots of those scenes.

&lt;div class=&#34;right&#34;&gt;
  &lt;a href=&#34;simple-py.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../simple-py.png&#34;&gt;&lt;/a&gt;
  &lt;a href=&#34;materials-py.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../materials-py.png&#34;&gt;&lt;/a&gt;
&lt;/div&gt;

&lt;div class=&#34;right&#34;&gt;
  |&lt;a href=&#34;basicshapes-cpp.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../basicshapes-cpp.png&#34;&gt;&lt;/a&gt;|&lt;a href=&#34;basicshapes-py.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../basicshapes-py.png&#34;&gt;&lt;/a&gt;|
  |:-:|:-:|
  |basicshapes-cpp|basicshapes-py|
&lt;/div&gt;

The coloring and lighting doesn&#39;t look that great for some reason. But it appears to be consistent with what you get when building and running the cpp examples from Qt Creator.


## Updating MainWindow to use QDockWidgets

The main conversion here was done in Qt Creator. I removed the main_splitter, added some QDockWidgets. and then migrated views and view layouts inside them. If I recall correctly, the QDockWidget is supposed to have its own QWidget, so I created those (e.g. slice_dock_widget_contents) and then migrated the views into the contents widgets. This may be unnecessary, the views might work with the DockWidgets as direct parents.

&lt;div class=&#34;right&#34;&gt;
  &lt;a href=&#34;qt-creator.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../qt-creator.png&#34;&gt;&lt;/a&gt;&lt;br&gt;
  New configuration of objects in QtCreator
&lt;/div&gt;



The goal here was to get flexible dock widgets that can be placed &#34;anywhere&#34; on the window. One thing that I had to understand about MainWindow is that it is organized around a &#34;Central Widget&#34; which is always in the center, and the dock areas, toolbars, and menu items are positioned in the surrounding areas. Thus, by default, dock widgets are confined to the dock regions surrounding the central widget.

&lt;div class=&#34;right&#34;&gt;
  &lt;a href=&#34;mainwindowlayout.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../mainwindowlayout.png&#34;&gt;&lt;/a&gt;&lt;br&gt;
  Dock Widgets surround a central widget
&lt;/div&gt;

The first thing I wanted to do is disable the centralWidget. My first approach was to delete the centralwidget Qidget in the .ui file. While it will build via pyuic and runs ok, this is not a good option because Qt Creator crashes when trying to open the edited ui file. Instead, I ended up disabling the central widget inside documentwindow.py by calling `self.setCentralWidget(None)`. This must be called after setupUi so it is not overridden.

&lt;div class=&#34;right&#34;&gt;
  |&lt;a href=&#34;cadnano-central-widget.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../cadnano-central-widget.png&#34;&gt;&lt;/a&gt;|&lt;a href=&#34;cadnano-no-central-widget.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../cadnano-no-central-widget.png&#34;&gt;&lt;/a&gt;|
  |:-:|:-:|
  |Qt Creator|Runtime|
&lt;/div&gt;

The next relevant property that can be used to add flexibility in dock positioning is to enable the AllowNestedDocks flag within the QMainWindow dockOptions. This allows docks to stack next to each other within the same dock area. Without nesting enabled, it seems that all dock widgets need to be touching the central widget with at least one corner, so you can&#39;t really stack them up in any configuration. The behavior is especially confusing when the central widget is not present.

&lt;div class=&#34;right&#34;&gt;
  &lt;a href=&#34;qmainwindow-settings.png&#34;&gt;&lt;img class=&#34;littlethumb&#34; src=&#34;../qmainwindow-settings.png&#34;&gt;&lt;/a&gt;&lt;br&gt;
  AllowNestedDocks
&lt;/div&gt;


&lt;div class=&#34;right&#34;&gt;
  |&lt;video width=&#34;400&#34; controls preload=&#34;none&#34; poster=&#34;../001-screen.png&#34;&gt;&lt;source src=&#34;../001.webm&#34;&gt;&lt;/video&gt;|
  |:-:|
  | views inside dock widgets |
&lt;/div&gt;

The initial working version is shown here, corresponding to the commit [77659b5](https://github.com/cadnano/cadnano2.5/commit/77659b57ece0b3949216de2244f0ba08454eb587).


**Future work** in order to be suitable for release:

1. The dock windows should be connected to actions to toggle them on or off. Right now you can close a dock widget and there is no way to get it back.
2. Layouts should be saved in the user preferences file so a layout can be recovered between sessions. Centering of the scenes.
3. Optional: default layouts might be saved to quickly switch between editing modes.


## Adding a 3D view to cadnano

I opted to work with the basicshapes demo and try to port it inside the cadnano interface. The first problem I ran into was a segfault that occurred when I copied the demo code into a dock widget within cadnano. Nick actually figured out the issue, which was that I neglected to store references to the PyQt3D objects in class variables within the app. Adding self references solved the problem.

&lt;div class=&#34;right&#34;&gt;
```
self.view3d = view
self.widget3d = widget
self.modifier3d = modifier
self.aspect3d = aspect
self.container3d = container
```
&lt;/div&gt;


With the basic demo working within its own widget, I experimented a bit with the default lighting and shaders. I added 2 directional lights to the scene, and attached some QSliders to allow for updating their worlddirection vectors at runtime. I also re-ordered the code and changed the default shader colors to cadnano-style colors.

&lt;div class=&#34;right&#34;&gt;
  &lt;a href=&#34;solidview.png&#34;&gt;&lt;img class=&#34;thumb&#34; src=&#34;../solidview.png&#34;&gt;&lt;/a&gt;&lt;br&gt;
&lt;/div&gt;

### Next steps

Now that the basic view is working and geometry can be displayed, I plan to begin implementing nucleicacidpart and virtualhelix items within the solid view. Starting with the part item, I&#39;ll just display a semi-transparent cube to mark the 3D boundaries of the part. Next, as vh items are added to the part, a solidview virtualhelixitem class will maintain the cylinder geometry for strands within that item.

The default mouse interaction with the 3D window is completely weird and backwards. Rotation is opposite of the mouse direction, and I think orbiting should work with left mouse button, not right mouse button. We may need to write our own custom .cpp version of the QOrbitCameraController to rewire these aspects of the class.
      </section>
      
      </div>
    </div>

    <script src="../../../../static/lib/reveal/lib/js/head.min.js?h=8c9495c7"></script>
    <script src="../../../../static/lib/reveal/js/reveal.js?h=19c4134c"></script>
    <script>
      // More info https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        center: false,
        history: true,
        margin: 0.2,
        transition: 'fade', // none/fade/slide/convex/concave/zoom
        transitionSpeed: 'fast', // default/fast/slow

        menu: {
            // Specifies which side of the presentation the menu will
            // be shown. Use 'left' or 'right'.
            side: 'left',

            // Add slide numbers to the titles in the slide list.
            // Use 'true' or format string (same as reveal.js slide numbers)
            numbers: false,

            // Specifies which slide elements will be used for generating
            // the slide titles in the menu. The default selects the first
            // heading element found in the slide, but you can specify any
            // valid css selector and the text from the first matching
            // element will be used.
            // Note: that a section data-menu-title attribute or an element
            // with a menu-title class will take precedence over this option
            titleSelector: 'h1, h2, h3, h4, h5, h6',

            // Hide slides from the menu that do not have a title.
            // Set to 'true' to only list slides with titles.
            hideMissingTitles: false,

            // Add markers to the slide titles to indicate the
            // progress through the presentation
            markers: true,

            // Specify custom panels to be included in the menu, by
            // providing an array of objects with 'title', 'icon'
            // properties, and either a 'src' or 'content' property.
            custom: false,

            // Specifies the themes that will be available in the themes
            // menu panel. Set to 'false' to hide themes panel.
            themes: [
                { name: 'Black', theme: '/static/lib/reveal/css/theme/black.css' },
                { name: 'White', theme: '/static/lib/reveal/css/theme/white.css' },
                { name: 'League', theme: '/static/lib/reveal/css/theme/league.css' },
                { name: 'Sky', theme: '/static/lib/reveal/css/theme/sky.css' },
                { name: 'Solarized', theme: '/static/lib/reveal/css/theme/solarized.css' }
            ],

            // Specifies if the transitions menu panel will be shown.
            transitions: true,

            // Adds a menu button to the slides to open the menu panel.
            // Set to 'false' to hide the button.
            openButton: true,

            // If 'true' allows the slide number in the presentation to
            // open the menu panel. The reveal.js slideNumber option must
            // be displayed for this to take effect
            openSlideNumber: false,

            // If true allows the user to open and navigate the menu using
            // the keyboard. Standard keyboard interaction with reveal
            // will be disabled while the menu is open.
            keyboard: true
        },

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
          { src: "../../../../static/lib/reveal/plugin/markdown/marked.js" },
          { src: "../../../../static/lib/reveal/plugin/markdown/markdown.js" },
          { src: "../../../../static/lib/reveal/plugin/menu/menu.js"},
          { src: "../../../../static/lib/reveal/plugin/zoom-js/zoom.js", async: true },
          { src: "../../../../static/lib/reveal/plugin/notes/notes.js", async: true },
          { src: "../../../../static/lib/reveal/plugin/highlight/highlight.js", async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
      });
    </script>

    <a href=".." id="exit-slides-link"><i class="fa fa-close" aria-hidden="true"></i></a>
  </body>
</html>
